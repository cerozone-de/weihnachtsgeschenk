<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Weihnachts-Jagd Ultimate</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #1a2e29; 
            --border-color: #F2E8C9; 
            --accent-color: #F08080; 
            --text-color: #F2E8C9;
            --pacman-blue: #1919A6;
        }
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Cinzel Decorative', cursive;
            text-align: center;
            margin: 0;
            padding: 10px 10px env(safe-area-inset-bottom) 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            touch-action: none; 
            height: 100vh; 
            overflow: hidden; 
            position: relative;
            box-sizing: border-box;
            border: 8px solid var(--border-color);
            border-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30"><path d="M1 1h28v28H1z" stroke="%23F2E8C9" stroke-width="2" fill="none"/><circle cx="1" cy="1" r="3" fill="%23F2E8C9"/><circle cx="29" cy="1" r="3" fill="%23F2E8C9"/><circle cx="1" cy="29" r="3" fill="%23F2E8C9"/><circle cx="29" cy="29" r="3" fill="%23F2E8C9"/></svg>') 10 repeat;
        }
        
        h1 { margin: 0; color: var(--accent-color); text-shadow: 2px 2px 0px #000; letter-spacing: 1px; font-size: 1.6rem; }
        
        /* --- SCHNEE EFFEKT --- */
        .snow-container {
            position: absolute; height: 100%; width: 100%; top: 0; left: 0; pointer-events: none; z-index: 0; overflow: hidden;
        }
        .snow {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-image: 
                radial-gradient(4px 4px at 50px 100px, #fff, transparent),
                radial-gradient(5px 5px at 150px 20px, #fff, transparent);
            background-size: 300px 300px; 
            animation: snowAnim 4s linear infinite; opacity: 0.9;
        }
        @keyframes snowAnim { from { transform: translateY(-300px); } to { transform: translateY(0px); } }

        /* --- HEADER --- */
        .header-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 95%;
            margin-bottom: 5px;
            border-bottom: 2px double var(--border-color);
            padding-bottom: 5px;
            z-index: 2;
        }
        #lives-display { font-size: 1.4rem; color: var(--accent-color); min-width: 80px; text-align: right;}
        #music-btn {
            background: transparent; border: 2px solid var(--border-color); color: var(--border-color);
            padding: 5px 10px; border-radius: 50%; font-size: 1.2rem; cursor: pointer;
        }

        /* --- SPIELFELD --- */
        #game-container {
            position: relative;
            width: fit-content;
            margin: 5px auto; 
            border: 4px solid var(--border-color); 
            background: #0d1a17;
            box-shadow: 0 0 20px rgba(0,0,0,0.5); 
            z-index: 2;
            flex-shrink: 1;
            max-height: 60vh;
            display: flex; justify-content: center; align-items: center;
        }
        
        canvas { 
            display: block; 
            background: #0d1a17; 
            max-width: 100%;
            height: auto;
            object-fit: contain;
        }

        #pause-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); color: #fff;
            font-size: 3rem; font-weight: bold; 
            display: flex; justify-content: center; align-items: center;
            z-index: 10; backdrop-filter: blur(2px);
        }
        .hidden { display: none !important; }

        /* --- STEUERUNG --- */
        .controls-wrapper {
            flex-grow: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center; width: 100%; padding-bottom: 10px;
            z-index: 10;
        }
        .swipe-hint {
            font-size: 0.8rem; color: rgba(242, 232, 201, 0.6); margin-top: 10px; font-style: italic;
        }
        .controls {
            display: grid;
            grid-template-columns: 75px 75px 75px; 
            grid-template-rows: 65px 65px;
            gap: 8px; justify-content: center;
        }
        @media (max-width: 400px) {
            .controls { grid-template-columns: 70px 70px 70px; grid-template-rows: 60px 60px; }
        }

        .ctrl-btn {
            background: rgba(255, 255, 255, 0.1); 
            border: 2px solid var(--border-color);
            color: var(--border-color);
            font-size: 30px; 
            border-radius: 12px;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent; 
            display: flex; align-items: center; justify-content: center;
        }
        .ctrl-btn:active { background: var(--border-color); color: #000; transform: scale(0.95); }

        /* --- POPUP FENSTER --- */
        .modal-screen {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: var(--bg-color); color: var(--text-color); padding: 25px;
            border: 6px double var(--border-color); box-shadow: 0 0 50px rgba(0,0,0,0.9);
            width: 85%; max-width: 380px; z-index: 100; max-height: 85vh; overflow-y: auto; text-align: center;
        }
        
        #start-screen-1 { display: block; } /* Zuerst Hallo Mausi */

        .modal-btn {
            display: inline-block; background: var(--accent-color); color: var(--bg-color);
            padding: 12px 25px; text-decoration: none; border-radius: 0; font-weight: bold;
            margin-top: 15px; font-size: 1.3rem; border: 3px solid var(--border-color); cursor: pointer;
            box-shadow: 0 4px 0 #a85a5a; font-family: 'Cinzel Decorative', cursive;
            width: 80%;
        }
        .mode-toggle {
            background: #444; color: #fff; margin-top: 10px; font-size: 1rem; padding: 10px;
            box-shadow: 0 4px 0 #222;
        }
        .active-mode {
            background: #FFD700; color: #000; box-shadow: 0 4px 0 #B8860B;
        }
    </style>
</head>
<body>

    <div class="snow-container">
        <div class="snow"></div>
        <div class="snow"></div>
    </div>

    <div class="header-info">
        <h1 id="game-title">WEIHNACHTS-JAGD</h1>
        <div class="status-right">
            <button id="music-btn" onclick="togglePause()">üîà</button>
            <div id="lives-display">‚ù§‚ù§‚ù§</div>
        </div>
    </div>
    
    <div id="game-area-touch" style="width: 100%; display: flex; flex-direction: column; align-items: center;">
        <div id="game-container">
            <div id="pause-overlay" class="hidden">PAUSE</div>
            <canvas id="gameCanvas"></canvas>
        </div>

        <div class="controls-wrapper">
            <div class="controls">
                <div></div>
                <button class="ctrl-btn" onpointerdown="movePlayer(0, -1)">‚¨ÜÔ∏è</button>
                <div></div>
                <button class="ctrl-btn" onpointerdown="movePlayer(-1, 0)">‚¨ÖÔ∏è</button>
                <button class="ctrl-btn" onpointerdown="movePlayer(0, 1)">‚¨áÔ∏è</button>
                <button class="ctrl-btn" onpointerdown="movePlayer(1, 0)">‚û°Ô∏è</button>
            </div>
            <div class="swipe-hint">Tipp: Wischen oder Tasten nutzen!</div>
        </div>
    </div>

    <div id="start-screen-1" class="modal-screen">
        <h2 style="margin-top: 0; color: var(--accent-color);">Hallo Mausi! ‚ù§Ô∏è</h2>
        <p>Wir haben hier ein Problem!</p>
        <p>Die <b>Schneem√§nner</b> haben den Geschenkebeutel zerrissen und nun sind alle Geschenke im Labyrinth verstreut.</p>
        <p style="font-size: 1.1rem; font-style: italic; color: #b0c4b1;">(Ich wei√ü nicht mehr welches deines war...)</p>
        <p>Wenn du sie einsammelst, finden wir es aber bestimmt wieder!</p>
        
        <button onclick="showTutorial()" class="modal-btn">WEITER ‚ñ∂</button>
    </div>

    <div id="start-screen-2" class="modal-screen">
        <h2 style="margin-top: 0; color: var(--accent-color);">ANLEITUNG</h2>
        <p id="tut-enemy">Vorsicht vor den Schneem√§nnern! ‚õÑ</p>
        <p id="tut-power">Iss die <b>Kekse</b> üç™, um stark zu werden!</p>
        <p>Dann kannst du sie fressen.</p>
        
        <button onclick="showMainMenu()" class="modal-btn">ZUR AUSWAHL ‚ñ∂</button>
    </div>

    <div id="main-menu" class="modal-screen">
        <h2 style="color: var(--accent-color);">EINSTELLUNGEN</h2>
        <p>W√§hle deine Schwierigkeit:</p>
        
        <button onclick="setDifficulty('easy')" class="modal-btn" style="background:#4caf50; box-shadow: 0 4px 0 #2e7d32;">LEICHT üòä</button>
        <button onclick="setDifficulty('hard')" class="modal-btn" style="background:#d32f2f; box-shadow: 0 4px 0 #8e0000;">SCHWER üî•</button>
        
        <hr style="margin: 20px 0; border-color: #555;">
        
        <button id="pacman-btn" onclick="togglePacmanMode()" class="modal-btn mode-toggle">
            Pac-Man Modus: AUS
        </button>
    </div>

    <div id="hit-screen" class="modal-screen">
        <h2 style="color: var(--accent-color);">AUTSCH! üí•</h2>
        <p>Erwischt!</p>
        <button onclick="continueAfterHit()" class="modal-btn">WEITER</button>
    </div>
    <div id="gameover-screen" class="modal-screen">
        <h2 style="color: var(--accent-color);">VORBEI... üò¢</h2>
        <p>Versuch es noch einmal!</p>
        <button onclick="location.reload()" class="modal-btn">NEUSTART üîÑ</button>
    </div>
    <div id="win-screen" class="modal-screen">
        <h2 style="margin-top: 0; color: var(--accent-color);">Frohe Weihnachten! üéÑ</h2>
        <p>Du bist fantastisch! Du hast alle Geschenke gerettet.<br>
        Ahh...hier ist ja auch dein Geschenk:</p>
        <a href="https://www.amazon.de/photos/share/cknGCtFk4Qzee7mr5H5ijfOGXuThL4rM8HIolqGBUXy" target="_blank" class="modal-btn">GESCHENK √ñFFNEN</a>
    </div>

    <script>
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        const livesDisplay = document.getElementById("lives-display");
        const pauseOverlay = document.getElementById("pause-overlay");
        const musicBtn = document.getElementById("music-btn");
        const pacmanBtn = document.getElementById("pacman-btn");
        const gameTitle = document.getElementById("game-title");
        
        const startScreen1 = document.getElementById("start-screen-1");
        const startScreen2 = document.getElementById("start-screen-2");
        const mainMenu = document.getElementById("main-menu");
        
        const hitScreen = document.getElementById("hit-screen");
        const gameOverScreen = document.getElementById("gameover-screen");

        // --- EINSTELLUNGEN ---
        let enemySpeedNormal = 600; 
        let isPacmanMode = false;

        // --- AUDIO ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let isMusicPlaying = false;
        
        function playTone(freq, duration, type='triangle') {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type; 
            osc.frequency.value = freq;
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        function startMusic() {
            if(!isMusicPlaying) {
                isMusicPlaying = true;
                musicLoop();
                musicBtn.innerText = "üîä";
            }
        }
        function stopMusic() { isMusicPlaying = false; musicBtn.innerText = "üîá"; }
        
        async function musicLoop() {
            const notes = [
                329, 329, 329,   329, 329, 329,   329, 392, 261, 293, 329,
                349, 349, 349, 349,   349, 329, 329, 329,   329, 293, 293, 329, 293, 392
            ];
            const durs = [
                0.2, 0.2, 0.4,   0.2, 0.2, 0.4,   0.2, 0.2, 0.2, 0.2, 0.8,
                0.2, 0.2, 0.2, 0.2,   0.2, 0.2, 0.2, 0.2,   0.2, 0.2, 0.2, 0.2, 0.2, 0.8
            ];
            
            let i = 0;
            while(isMusicPlaying && !gameOver) {
                playTone(notes[i], durs[i], isPacmanMode ? 'square' : 'triangle'); 
                await new Promise(r => setTimeout(r, durs[i]*1000));
                i++;
                if (i >= notes.length) i = 0; 
            }
        }

        async function playWinMusic() {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            
            // KORRIGIERTE UND VOLLST√ÑNDIGE MELODIE
            const winMelody = [
                // We wish you a merry Christmas
                {f:392, d:0.4}, // G
                {f:523, d:0.4}, // C
                {f:523, d:0.2}, {f:587, d:0.2}, {f:523, d:0.2}, {f:493, d:0.2}, // C-D-C-B
                {f:440, d:0.4}, {f:440, d:0.4}, // A A

                // We wish you a merry Christmas
                {f:587, d:0.4}, // D
                {f:587, d:0.2}, {f:659, d:0.2}, {f:587, d:0.2}, {f:523, d:0.2}, // D-E-D-C
                {f:493, d:0.4}, {f:392, d:0.4}, // B G

                // We wish you a merry Christmas
                {f:392, d:0.2}, {f:392, d:0.2}, // G G
                {f:659, d:0.4}, // E
                {f:659, d:0.2}, {f:698, d:0.2}, {f:659, d:0.2}, {f:587, d:0.2}, // E-F-E-D
                {f:523, d:0.4}, {f:440, d:0.4}, // C A

                // And a happy New Year
                {f:392, d:0.2}, {f:392, d:0.2}, // G G
                {f:440, d:0.4}, {f:587, d:0.4}, // A D
                {f:493, d:0.4}, {f:523, d:0.8}  // B C
            ];
            
            for(let note of winMelody) {
                playTone(note.f, note.d, 'sine');
                await new Promise(r => setTimeout(r, note.d * 1000));
            }
        }

        // --- MEN√ú FLUSS ---
        function showTutorial() {
            startScreen1.style.display = "none";
            startScreen2.style.display = "block";
            if(navigator.vibrate) navigator.vibrate(50);
        }

        function showMainMenu() {
            startScreen2.style.display = "none";
            mainMenu.style.display = "block";
            if(navigator.vibrate) navigator.vibrate(50);
        }

        function togglePacmanMode() {
            isPacmanMode = !isPacmanMode;
            if(isPacmanMode) {
                pacmanBtn.innerText = "Pac-Man Modus: AN";
                pacmanBtn.classList.add("active-mode");
                gameTitle.innerText = "PAC-MAN JAGD";
                document.getElementById("tut-enemy").innerText = "Vorsicht vor den Geistern! üëª";
                document.getElementById("tut-power").innerText = "Iss die Power-Pillen üü°!";
            } else {
                pacmanBtn.innerText = "Pac-Man Modus: AUS";
                pacmanBtn.classList.remove("active-mode");
                gameTitle.innerText = "WEIHNACHTS-JAGD";
                document.getElementById("tut-enemy").innerText = "Vorsicht vor den Schneem√§nnern! ‚õÑ";
                document.getElementById("tut-power").innerText = "Iss die Kekse üç™!";
            }
        }

        function setDifficulty(level) {
            if(level === 'easy') {
                enemySpeedNormal = 600; 
            } else {
                enemySpeedNormal = 350; 
            }
            mainMenu.style.display = "none";
            // SPIEL START
            gameRunning = true;
            initGame();
            startMusic(); 
            if(navigator.vibrate) navigator.vibrate(100);
            
            // Pacman Animation Timer
            setInterval(() => { player.mouthOpen = !player.mouthOpen; }, 200);
        }

        // --- GAME LOGIC ---
        const TILE_SIZE = 26; 
        
        let giftsCollected = 0;
        let totalGifts = 0;
        let gameOver = false;
        let isPaused = false;
        let gameRunning = false; 
        let inputBlocked = false; 
        let lives = 3;
        
        let powerUpActive = false;
        let powerUpTimer = null;

        let map = [
            [1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,0,0,1,0,0,3,0,0,1,0,0,1],
            [1,0,1,1,0,1,1,1,0,1,1,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,1,1,0,1,0,1,0,1,0,1,1,1],
            [1,0,0,0,1,0,3,0,1,0,0,0,1],
            [1,0,1,1,1,0,1,0,1,1,1,0,1],
            [1,0,0,3,0,0,1,0,0,3,0,0,1],
            [1,1,0,1,1,1,1,1,1,1,0,1,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,1,1,0,1,0,1,0,1,1,0,1],
            [1,0,0,0,0,1,3,1,0,0,0,0,1],
            [1,0,1,1,1,1,1,1,1,1,1,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1]
        ];

        let rows = map.length;
        let cols = map[0].length;
        canvas.width = cols * TILE_SIZE;
        canvas.height = rows * TILE_SIZE;

        let player = { x: 1, y: 1, mouthOpen: true }; 
        let enemies = [
            { x: 11, y: 1, lastMoveTime: 0, alive: true, color: "red" },
            { x: 1, y: 13, lastMoveTime: 0, alive: true, color: "pink" },
            { x: 11, y: 13, lastMoveTime: 0, alive: true, color: "cyan" }
        ];

        // --- SWIPE ---
        let touchStartX = 0;
        let touchStartY = 0;
        document.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
        }, {passive: false});
        document.addEventListener('touchend', e => {
            if(!gameRunning || isPaused || inputBlocked) return;
            let touchEndX = e.changedTouches[0].screenX;
            let touchEndY = e.changedTouches[0].screenY;
            let diffX = touchEndX - touchStartX;
            let diffY = touchEndY - touchStartY;
            if(Math.abs(diffX) > Math.abs(diffY)) {
                if(Math.abs(diffX) > 30) movePlayer(diffX > 0 ? 1 : -1, 0);
            } else {
                if(Math.abs(diffY) > 30) movePlayer(0, diffY > 0 ? 1 : -1);
            }
        }, {passive: false});

        // --- KEYBOARD ---
        document.addEventListener('keydown', (e) => {
            if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].indexOf(e.code) > -1) e.preventDefault();
            if (!gameRunning || isPaused || gameOver || inputBlocked) return;
            switch(e.key) {
                case 'ArrowUp': movePlayer(0, -1); break;
                case 'ArrowDown': movePlayer(0, 1); break;
                case 'ArrowLeft': movePlayer(-1, 0); break;
                case 'ArrowRight': movePlayer(1, 0); break;
                case 'p': case 'P': togglePause(); break; 
            }
        });

        function initGame() {
            totalGifts = 0;
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    if (map[r][c] === 0 || map[r][c] === 3) totalGifts++;
                }
            }
            if(map[player.y][player.x] === 0) { map[player.y][player.x] = 2; totalGifts--; }
            updateLives();
            draw();
            requestAnimationFrame(gameLoop);
        }

        function togglePause() {
            if(gameOver || !gameRunning || inputBlocked) return;
            isPaused = !isPaused;
            if(isPaused) { stopMusic(); pauseOverlay.classList.remove("hidden"); } 
            else { startMusic(); pauseOverlay.classList.add("hidden"); }
        }

        function updateLives() {
            let hearts = "";
            for(let i=0; i<lives; i++) hearts += "‚ù§";
            livesDisplay.innerText = hearts;
        }

        function movePlayer(dx, dy) {
            let newX = player.x + dx;
            let newY = player.y + dy;
            if (map[newY][newX] !== 1) {
                player.x = newX;
                player.y = newY;
                checkCollection();
                checkCollision();
                draw();
            }
        }

        function activatePowerUp() {
            powerUpActive = true;
            clearTimeout(powerUpTimer);
            powerUpTimer = setTimeout(() => { powerUpActive = false; }, 10000);
            if(navigator.vibrate) navigator.vibrate([100, 50, 100]);
            playTone(600, 0.2, 'sine');
        }

        function moveEnemy(enemyObj) {
            if(!enemyObj.alive) return; 
            let possibleMoves = [];
            if(map[enemyObj.y-1][enemyObj.x] !== 1) possibleMoves.push({dx:0, dy:-1}); 
            if(map[enemyObj.y+1][enemyObj.x] !== 1) possibleMoves.push({dx:0, dy:1});  
            if(map[enemyObj.y][enemyObj.x-1] !== 1) possibleMoves.push({dx:-1, dy:0}); 
            if(map[enemyObj.y][enemyObj.x+1] !== 1) possibleMoves.push({dx:1, dy:0});  
            
            if(possibleMoves.length > 0) {
                let moved = false;
                let targetX = powerUpActive ? (2 * enemyObj.x - player.x) : player.x;
                let targetY = powerUpActive ? (2 * enemyObj.y - player.y) : player.y;

                if(Math.random() < 0.7) { 
                    let bestMove = possibleMoves[0]; let bestDist = 9999;
                    possibleMoves.forEach(m => {
                        let dx = (enemyObj.x + m.dx) - targetX;
                        let dy = (enemyObj.y + m.dy) - targetY;
                        let dist = dx*dx + dy*dy;
                        if(dist < bestDist) { bestDist = dist; bestMove = m; }
                    });
                    if(bestMove) { enemyObj.x += bestMove.dx; enemyObj.y += bestMove.dy; moved = true; }
                }
                if(!moved) {
                    let move = possibleMoves[Math.floor(Math.random() * possibleMoves.length)];
                    enemyObj.x += move.dx; enemyObj.y += move.dy;
                }
            }
        }

        function checkCollection() {
            let tile = map[player.y][player.x];
            if (tile === 0 || tile === 3) {
                if(tile === 3) activatePowerUp();
                else if(navigator.vibrate) navigator.vibrate(30); 
                map[player.y][player.x] = 2; 
                giftsCollected++;
                if (giftsCollected === totalGifts) winGame();
            }
        }

        function checkCollision() {
            if(inputBlocked) return; 
            enemies.forEach(enemy => {
                if (enemy.alive && player.x === enemy.x && player.y === enemy.y) {
                    if(powerUpActive) {
                        enemy.alive = false;
                        if(navigator.vibrate) navigator.vibrate(80); 
                        playTone(800, 0.1, 'square');
                        setTimeout(() => { enemy.x = 6; enemy.y = 7; enemy.alive = true; }, 5000);
                    } else {
                        if(navigator.vibrate) navigator.vibrate([200, 100, 200]); 
                        lives--; updateLives(); inputBlocked = true; 
                        if (lives > 0) { hitScreen.style.display = "block"; stopMusic(); } 
                        else { gameOverScreen.style.display = "block"; gameOver = true; stopMusic(); }
                    }
                }
            });
        }

        function continueAfterHit() {
            hitScreen.style.display = "none"; 
            player.x = 1; player.y = 1; 
            enemies[0].x = 11; enemies[0].y = 1;
            enemies[1].x = 1; enemies[1].y = 13;
            enemies[2].x = 11; enemies[2].y = 13;
            inputBlocked = false; startMusic();
            draw();
        }

        function winGame() {
            gameOver = true; stopMusic(); 
            playWinMusic(); 
            draw();
            setTimeout(() => { document.getElementById("win-screen").style.display = "block"; }, 500);
        }

        // --- ZEICHNEN ---
        function drawPacman(x, y) {
            let cx = x + TILE_SIZE/2;
            let cy = y + TILE_SIZE/2;
            ctx.fillStyle = "yellow";
            ctx.beginPath();
            if(player.mouthOpen) {
                ctx.arc(cx, cy, TILE_SIZE/2 - 2, 0.2 * Math.PI, 1.8 * Math.PI);
                ctx.lineTo(cx, cy);
            } else {
                ctx.arc(cx, cy, TILE_SIZE/2 - 2, 0, 2 * Math.PI);
            }
            ctx.fill();
        }

        function drawGhost(x, y, color) {
            let cx = x + TILE_SIZE/2;
            let cy = y + TILE_SIZE/2;
            ctx.fillStyle = powerUpActive ? "blue" : color;
            
            // Geisterkopf
            ctx.beginPath();
            ctx.arc(cx, cy - 2, TILE_SIZE/2 - 4, Math.PI, 0);
            ctx.lineTo(x + TILE_SIZE - 4, y + TILE_SIZE - 4);
            ctx.lineTo(x + 4, y + TILE_SIZE - 4);
            ctx.fill();

            // Augen
            ctx.fillStyle = "white";
            ctx.beginPath(); ctx.arc(cx - 3, cy - 4, 3, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(cx + 3, cy - 4, 3, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = "black";
            ctx.beginPath(); ctx.arc(cx - 3, cy - 4, 1.5, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(cx + 3, cy - 4, 1.5, 0, Math.PI*2); ctx.fill();
        }

        function draw() {
            // Hintergrund je nach Modus
            if(isPacmanMode) {
                ctx.fillStyle = "black";
            } else {
                ctx.fillStyle = "#0d1a17"; 
            }
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.textAlign = "center"; ctx.textBaseline = "middle";

            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    let x = c * TILE_SIZE; let y = r * TILE_SIZE; let cell = map[r][c];
                    
                    if (cell === 1) {
                        // W√ÑNDE
                        if(isPacmanMode) {
                            ctx.strokeStyle = "#1919A6";
                            ctx.lineWidth = 2;
                            ctx.strokeRect(x+4, y+4, TILE_SIZE-8, TILE_SIZE-8);
                        } else {
                            let grad = ctx.createLinearGradient(x, y, x+TILE_SIZE, y+TILE_SIZE);
                            grad.addColorStop(0, "#e0f7fa"); grad.addColorStop(1, "#4dd0e1");
                            ctx.fillStyle = grad;
                            ctx.beginPath(); ctx.roundRect(x, y, TILE_SIZE, TILE_SIZE, 3); ctx.fill();
                            ctx.fillStyle = "rgba(255,255,255,0.4)"; ctx.fillRect(x+2, y+2, 5, 5);
                        }
                    } else {
                        // ITEMS
                        ctx.fillStyle = "#ffffff";
                        if (cell === 0) {
                            if(isPacmanMode) {
                                ctx.fillStyle = "#ffb897"; // Lachsfarbene Punkte
                                ctx.fillRect(x + TILE_SIZE/2 - 2, y + TILE_SIZE/2 - 2, 4, 4);
                            } else {
                                ctx.font = (TILE_SIZE * 0.75) + "px serif";
                                ctx.fillText("üéÅ", x + TILE_SIZE/2, y + TILE_SIZE/2 + 2);
                            }
                        } else if (cell === 3) {
                            if(isPacmanMode) {
                                ctx.fillStyle = "#ffb897"; 
                                ctx.beginPath(); ctx.arc(x+TILE_SIZE/2, y+TILE_SIZE/2, 6, 0, Math.PI*2); ctx.fill();
                            } else {
                                ctx.font = (TILE_SIZE * 0.75) + "px serif";
                                ctx.fillText("üç™", x + TILE_SIZE/2, y + TILE_SIZE/2 + 2);
                            }
                        }
                    }
                }
            }
            
            // SPIELER
            if(isPacmanMode) {
                drawPacman(player.x * TILE_SIZE, player.y * TILE_SIZE);
            } else {
                ctx.fillStyle = "#ffffff";
                ctx.font = (TILE_SIZE * 0.85) + "px serif";
                ctx.fillText("ü§∂", player.x * TILE_SIZE + TILE_SIZE/2, player.y * TILE_SIZE + TILE_SIZE/2 + 2);
            }
            
            // GEGNER
            enemies.forEach(enemy => {
                if(enemy.alive) {
                    if(isPacmanMode) {
                        drawGhost(enemy.x * TILE_SIZE, enemy.y * TILE_SIZE, enemy.color);
                    } else {
                        ctx.fillStyle = "#ffffff";
                        if(powerUpActive) ctx.fillText("ü•∂", enemy.x * TILE_SIZE + TILE_SIZE/2, enemy.y * TILE_SIZE + TILE_SIZE/2 + 2);
                        else ctx.fillText("‚õÑ", enemy.x * TILE_SIZE + TILE_SIZE/2, enemy.y * TILE_SIZE + TILE_SIZE/2 + 2);
                    }
                }
            });
        }

        function gameLoop(timestamp) {
            if (!gameOver && gameRunning) {
                if (!isPaused && !inputBlocked) {
                    let enemiesMoved = false;
                    let currentSpeed = powerUpActive ? 800 : enemySpeedNormal;
                    
                    enemies.forEach(enemy => {
                        if (timestamp - enemy.lastMoveTime > currentSpeed) {
                            moveEnemy(enemy); enemy.lastMoveTime = timestamp; enemiesMoved = true;
                        }
                    });
                    if(enemiesMoved) { draw(); checkCollision(); }
                }
                requestAnimationFrame(gameLoop);
            }
        }
    </script>
</body>
</html>
